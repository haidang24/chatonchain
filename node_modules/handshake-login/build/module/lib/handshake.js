import { Resolver } from 'dns/promises';
import doh from 'dohjs';
import strategies from './strategies';
import { concatTypedArrays, decodeBase64, encodeBase64, hash, parseTxtRecordData, } from './utils';
const DEFAULT_STRATEGY_NAME = 'LocalStorageStrategy';
const DEFAULT_DOH_RESOLVER = 'https://query.hdns.io/dns-query';
const DEFAULT_DNS_RESOLVERS = [
    '103.196.38.38',
    '103.196.38.39',
    '103.196.38.40',
];
export class HandshakeLogin {
    strategy;
    useDoh;
    resolver;
    dohResolver;
    domain;
    idManager;
    deviceId;
    prefix;
    reqData;
    resData;
    identity;
    constructor({ useDoh = false, strategy = new strategies[DEFAULT_STRATEGY_NAME].strategy(), dohResolverUrl = DEFAULT_DOH_RESOLVER, dnsResolvers = DEFAULT_DNS_RESOLVERS, } = {}) {
        this.useDoh = useDoh;
        this.strategy = strategy;
        if (useDoh) {
            this.dohResolver = new doh.DohResolver(dohResolverUrl);
        }
        else {
            this.resolver = new Resolver();
            const servers = dnsResolvers ?? DEFAULT_DNS_RESOLVERS;
            this.resolver.setServers(servers);
        }
    }
    /**
     * Make DNS Queries
     * @param domain Domain name
     * @param type DNS record type
     * @returns DNS Response Answers array (or null)
     */
    async makeDnsQuery(domain, type) {
        if (!domain)
            throw new Error('Domain not set.');
        if (this.useDoh) {
            const dnsResponse = await this.dohResolver.query(domain, type, 'GET');
            if (!dnsResponse.answers.length)
                return null;
            return dnsResponse.answers.map((ans) => {
                return {
                    name: ans.name,
                    type: ans.type,
                    value: String.fromCharCode.apply(null, concatTypedArrays(ans.data)),
                };
            });
        }
        else {
            try {
                const answers = await this.resolver.resolve(domain, type);
                return answers.map((ans) => {
                    return { name: domain, type: type, value: ans.join() };
                });
            }
            catch (error) {
                return null;
            }
        }
    }
    /**
     * Get ID Manager
     * @param domain Domain name
     * @returns url or null
     */
    async getIdManager() {
        const dnsResponse = await this.makeDnsQuery(`_idmanager.${this.domain}`, 'TXT');
        if (!dnsResponse?.length)
            return 'https://id.namebase.io';
        const idManagerRecord = parseTxtRecordData(dnsResponse[0].value);
        this.idManager = idManagerRecord.url;
        return this.idManager;
    }
    /**
     * Generate Request URL
     * @returns Request URL
     */
    async generateRequestUrl({ domain, challenge, callbackUrl, }) {
        if (!domain)
            throw new Error('Domain not set.');
        if (!challenge)
            throw new Error('Challenge not set.');
        if (!callbackUrl)
            throw new Error('Callback URL not set.');
        this.domain = domain.toLowerCase();
        const idMgrUrl = await this.getIdManager();
        return `${idMgrUrl}/#/login?state=${encodeBase64(challenge)}&id=${encodeBase64(this.domain)}&callbackUrl=${encodeBase64(callbackUrl)}`;
    }
    /**
     * Set Request Data
     * @param reqData Request data to set
     */
    setRequestData(reqData) {
        if (!reqData)
            throw new Error('Request Data not set.');
        this.reqData = reqData;
        this.domain = reqData.domain.toLowerCase();
        this.strategy.setRequestData(this.reqData);
    }
    /**
     * Parse Request Data from URL
     * Uses window.location if url is not passed.
     * @param url url with request data to be parsed
     * @returns request data object
     */
    parseRequestDataFromUrl(url = null) {
        if (!url) {
            url = window.location.href;
        }
        const hash = new URL(url).hash;
        const queryIndex = hash.indexOf('?');
        const regex = /([^&=]+)=([^&]*)/g;
        const queryString = hash.substr(queryIndex + 1);
        const params = queryString
            .match(regex)
            .reduce((data, part) => {
            const idx = part.indexOf('=');
            return {
                ...data,
                [part.slice(0, idx)]: decodeBase64(part.slice(idx + 1, part.length)),
            };
        }, {});
        this.setRequestData({
            domain: params.id,
            challenge: params.state,
            callbackUrl: params.callbackUrl,
        });
        return this.reqData;
    }
    /**
     * Get Device Record
     * @returns Device Record Data
     */
    async getDeviceRecord() {
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.prefix)
            throw new Error('Prefix not set.');
        const dnsResponse = await this.makeDnsQuery(`${this.prefix}._auth.${this.domain}`, 'TXT');
        if (!dnsResponse?.length)
            return null;
        const deviceRecord = parseTxtRecordData(dnsResponse[0].value);
        this.strategy.setDeviceRecord(deviceRecord);
        return deviceRecord;
    }
    /**
     * Generate DNS Record
     * @returns DNS Record
     */
    async generateDnsRecord() {
        return this.strategy.generateDnsRecord(this.prefix);
    }
    /**
     * Verify Fingerprint with DNS
     * @param fingerprint Expected fingerprint
     * @returns boolean if fingerprint is found
     */
    async verifyFingerprintWithDNS(fingerprint = null) {
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.prefix)
            throw new Error('Prefix not set.');
        const fingerprintToCompare = fingerprint ?? this.identity.fingerprint;
        const txtData = await this.getDeviceRecord();
        if (!txtData)
            return false;
        return txtData.fingerprint === fingerprintToCompare;
    }
    /**
     * Use Strategy
     * @param strategy strategy to use
     */
    async useStrategy(strategy) {
        if (!strategy)
            throw new Error('Strategy not set.');
        this.strategy = strategy;
        if (this.reqData)
            this.strategy.setRequestData(this.reqData);
        if (this.resData)
            this.strategy.setResponseData(this.resData);
    }
    /**
     * Get Device ID
     * also calculates prefix
     * @returns device id
     */
    async getDeviceId() {
        this.deviceId = await this.strategy.getDeviceId();
        await this.getPrefix();
        return this.deviceId;
    }
    /**
     * Generate Identity
     * @returns Identity
     */
    async generateIdentity() {
        this.identity = await this.strategy.generateIdentity();
        return this.identity;
    }
    /**
     * Get existing Identity
     * @returns Identity
     */
    async getIdentity() {
        this.identity = await this.strategy.getIdentity();
        return this.identity;
    }
    /**
     * Get Prefix
     * based on domain and device id
     * @returns prefix
     */
    async getPrefix() {
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.deviceId)
            throw new Error('Device ID not set.');
        this.prefix = (await hash(this.domain + this.deviceId)).slice(0, 16);
        return this.prefix;
    }
    /**
     * Sign Challenge
     * @returns signature
     */
    async sign() {
        return this.strategy.sign();
    }
    /**
     * Verify Signature
     * @param challenge
     * @returns boolean whether valid signaure
     */
    async verify(challenge) {
        return this.strategy.verify(challenge);
    }
    /**
     * Generate Response Data
     * @returns Response Data
     */
    async generateResponseData() {
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.prefix)
            throw new Error('Prefix not set.');
        if (!this.identity?.publicKey)
            throw new Error('Public Key not set.');
        if (!this.strategy)
            throw new Error('Strategy not set.');
        const data = {
            domain: encodeBase64(this.domain),
            deviceId: encodeBase64(this.prefix),
            publicKey: encodeBase64(this.identity.publicKey),
            strategy: encodeBase64(this.strategy.strategyName),
            ...(await this.strategy.generateSignatureData()),
        };
        return data;
    }
    /**
     * Generate Response URL
     * @returns response url
     */
    async generateResponseUrl() {
        if (!this.reqData?.callbackUrl)
            throw new Error('Callback URL not set.');
        const data = await this.generateResponseData();
        const url = new URL(this.reqData.callbackUrl);
        url.hash = encodeBase64(JSON.stringify(data)); // JSON => str => b64
        return url.toString();
    }
    /**
     * Set Response Data
     * @param resData Response Data
     */
    setResponseData(resData) {
        if (!resData)
            throw new Error('Response Data not set.');
        this.resData = resData;
        this.domain = resData.domain.toLowerCase();
        this.prefix = resData.prefix ?? resData.deviceId;
        this.strategy.setResponseData(this.resData);
    }
    /**
     * Parse Response Data From URL
     * @param url response url
     * @returns Response Data
     */
    parseResponseDataFromUrl(url = null) {
        const hash = new URL(url).hash;
        const b64encoded = hash.slice(1);
        const data = JSON.parse(decodeBase64(b64encoded));
        Object.keys(data).map(function (key) {
            data[key] = decodeBase64(data[key]);
        });
        data.prefix = data.deviceId;
        delete data.deviceId;
        this.setResponseData(data);
        return data;
    }
    /**
     * Verify Response Data
     * Checks signature of challenge and fingerprint with DNS.
     * @param challenge challenge to verify
     * @returns boolean whether valid response
     */
    async verifyResponseData(challenge) {
        if (!challenge)
            throw new Error('Challenge not set.');
        const strategy = strategies[this.resData.strategy ?? DEFAULT_STRATEGY_NAME] ?? null;
        if (!strategy)
            throw new Error('Strategy not found. You may need to update the library.');
        this.useStrategy(new strategy.strategy());
        const fingerprint = await this.strategy.getFingerprint();
        const fpMatched = await this.verifyFingerprintWithDNS(fingerprint);
        if (!fpMatched)
            return false;
        return this.strategy.verify(challenge);
    }
}
export const Strategies = strategies;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZHNoYWtlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9oYW5kc2hha2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUV4QyxPQUFPLEdBQUcsTUFBTSxPQUFPLENBQUM7QUFFeEIsT0FBTyxVQUFVLE1BQU0sY0FBYyxDQUFDO0FBRXRDLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsWUFBWSxFQUNaLFlBQVksRUFDWixJQUFJLEVBQ0osa0JBQWtCLEdBQ25CLE1BQU0sU0FBUyxDQUFDO0FBRWpCLE1BQU0scUJBQXFCLEdBQUcsc0JBQXNCLENBQUM7QUFDckQsTUFBTSxvQkFBb0IsR0FBRyxpQ0FBaUMsQ0FBQztBQUMvRCxNQUFNLHFCQUFxQixHQUFHO0lBQzVCLGVBQWU7SUFDZixlQUFlO0lBQ2YsZUFBZTtDQUNoQixDQUFDO0FBRUYsTUFBTSxPQUFPLGNBQWM7SUFDekIsUUFBUSxDQUFtQjtJQUMzQixNQUFNLENBQVU7SUFDaEIsUUFBUSxDQUFDO0lBQ1QsV0FBVyxDQUFrQjtJQUU3QixNQUFNLENBQVM7SUFDZixTQUFTLENBQVM7SUFDbEIsUUFBUSxDQUFTO0lBQ2pCLE1BQU0sQ0FBUztJQUNmLE9BQU8sQ0FBYztJQUNyQixPQUFPLENBQWU7SUFDdEIsUUFBUSxDQUFXO0lBRW5CLFlBQVksRUFDVixNQUFNLEdBQUcsS0FBSyxFQUNkLFFBQVEsR0FBRyxJQUFJLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUMzRCxjQUFjLEdBQUcsb0JBQW9CLEVBQ3JDLFlBQVksR0FBRyxxQkFBcUIsR0FDckMsR0FBRyxFQUFFO1FBQ0osSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFFekIsSUFBSSxNQUFNLEVBQUU7WUFDVixJQUFJLENBQUMsV0FBVyxH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