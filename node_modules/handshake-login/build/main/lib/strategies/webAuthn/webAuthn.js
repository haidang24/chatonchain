"use strict";
/* eslint-disable @typescript-eslint/ban-ts-comment */
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebAuthnStrategy = void 0;
const utils_1 = require("../../utils");
const abstract_1 = require("../abstract");
const cryptography_1 = require("./cryptography");
/**
 * WebAuthn Strategy
 */
class WebAuthnStrategy extends abstract_1.AbstractStrategy {
    constructor() {
        super();
        this.strategyName = 'WebAuthnStrategy';
    }
    /**
     * Reset all properties
     */
    reset() {
        this.domain = null;
        this.identity = null;
        this.signature = null;
        this.clientDataJSON = null;
        this.authenticatorData = null;
        this.reqData = null;
        this.resData = null;
        this.deviceRecord = null;
    }
    /**
     * Set Request Data
     * @param reqData Request data to set
     */
    setRequestData(reqData) {
        this.reset();
        this.reqData = reqData;
        this.domain = reqData.domain.toLowerCase();
    }
    /**
     * Set Device Record
     * @param deviceRecord Device record to set
     */
    setDeviceRecord(deviceRecord) {
        this.deviceRecord = deviceRecord;
    }
    /**
     * Set Response Data
     * @param resData Response data to set
     */
    setResponseData(resData) {
        this.resData = resData;
        this.domain = resData.domain;
    }
    /**
     * Get Device ID
     * @returns device id
     */
    async getDeviceId() {
        return window.location.hostname;
    }
    /**
     * Create Challenge from Request Data
     * @returns challenge as Uint8Array
     */
    _createChallenge() {
        if (!this.reqData.challenge)
            throw new Error('Challenge not set.');
        const challenge = utils_1.stringToArrayBuffer(this.reqData.challenge);
        return new Uint8Array(challenge);
    }
    /**
     * Generate new Identity
     * @returns Identity
     */
    async generateIdentity() {
        if (!this.domain)
            throw new Error('Domain not set.');
        const challenge = this._createChallenge();
        const credential = await navigator.credentials.create({
            publicKey: {
                challenge: new Uint8Array(challenge),
                rp: { name: 'Handshake Login', id: window.location.hostname },
                user: {
                    id: new Uint8Array([79]),
                    name: this.domain,
                    displayName: this.domain,
                },
                pubKeyCredParams: [
                    { type: 'public-key', alg: -7 },
                    { type: 'public-key', alg: -257 },
                ],
                timeout: 60000,
                attestation: 'direct',
            },
        });
        // @ts-ignore
        const publicKeyAb = credential.response.getPublicKey();
        const publicKey = await utils_1.SubtleCrypto.importKey('spki', publicKeyAb, {
            name: 'ECDH',
            namedCurve: 'P-256',
        }, true, []);
        const publicKeyPem = await utils_1.exportCryptoKey(publicKey);
        const identity = {
            name: this.domain,
            // @ts-ignore
            keyId: utils_1.encodeBase64(utils_1.arrayBufferToString(credential.rawId)).replace(/=+$/, ''),
            publicKey: publicKeyPem,
            fingerprint: await utils_1.hash(publicKeyPem),
        };
        this.identity = identity;
        return identity;
    }
    /**
     * Get an Identity
     * @param domain domain name
     * @returns Identity object
     */
    async getIdentity() {
        var _a;
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.deviceRecord)
            return null;
        if (!((_a = this.deviceRecord) === null || _a === void 0 ? void 0 : _a.keyId))
            throw new Error('Key ID not set.');
        const challenge = this._createChallenge();
        const credential = await navigator.credentials.get({
            publicKey: {
                challenge: challenge,
                rpId: window.location.hostname,
                allowCredentials: [
                    {
                        type: 'public-key',
                        id: utils_1.stringToArrayBuffer(utils_1.decodeBase64(this.deviceRecord.keyId)),
                    },
                ],
                userVerification: 'discouraged',
            },
        });
        let publicKey;
        try {
            publicKey = await utils_1.SubtleCrypto.importKey('spki', utils_1.stringToArrayBuffer(utils_1.decodeBase64(this.deviceRecord.pubKey)), {
                name: 'ECDH',
                namedCurve: 'P-256',
            }, true, []);
        }
        catch (error) {
            console.error(error);
            throw new Error('Could not import invalid public key.');
        }
        const publicKeyPem = await utils_1.exportCryptoKey(publicKey);
        const identity = {
            name: this.domain,
            keyId: this.deviceRecord.keyId,
            publicKey: publicKeyPem,
            fingerprint: await utils_1.hash(publicKeyPem),
        };
        this.identity = identity;
        // @ts-ignore
        this.signature = credential.response.signature;
        // @ts-ignore
        this.authenticatorData = credential.response.authenticatorData;
        // @ts-ignore
        this.clientDataJSON = credential.response.clientDataJSON;
        return identity;
    }
    /**
     * Sign challenge
     * @returns signed data
     */
    async sign() {
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.reqData.challenge)
            throw new Error('Challenge not set.');
        return utils_1.encodeBase64(this.signature);
    }
    /**
     * Verify signature
     * @param challenge challenge to verify signature with
     * @returns boolean if signature verified
     */
    async verify(challenge) {
        if (!challenge)
            throw new Error('Challenge not set.');
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!this.resData)
            throw new Error('Response Data not set.');
        const clientDataJSON = utils_1.stringToArrayBuffer(this.resData.clientDataJSON);
        const authenticatorData = utils_1.stringToArrayBuffer(this.resData.authenticatorData);
        const clientData = JSON.parse(this.resData.clientDataJSON);
        if (utils_1.encodeBase64(challenge).replace(/=+$/, '') !== clientData.challenge) {
            return false;
        }
        const clientDataJSONHash = await utils_1.SubtleCrypto.digest('SHA-256', clientDataJSON);
        const verifiableData = new Uint8Array(authenticatorData.byteLength + clientDataJSONHash.byteLength);
        verifiableData.set(new Uint8Array(authenticatorData), 0);
        verifiableData.set(new Uint8Array(clientDataJSONHash), authenticatorData.byteLength);
        const publicKeyObj = await cryptography_1.importCryptoKey(this.resData.publicKey);
        const signatureVerified = await cryptography_1.verifySignature(publicKeyObj, utils_1.stringToArrayBuffer(this.resData.signed), verifiableData);
        return signatureVerified;
    }
    /**
     * Generate DNS Record for Identity
     * @param prefix derived from domain and device id
     * @returns DNSRecord
     */
    async generateDnsRecord(prefix) {
        var _a, _b, _c;
        if (!prefix)
            throw new Error('Prefix not set.');
        if (!this.domain)
            throw new Error('Domain not set.');
        if (!((_a = this.identity) === null || _a === void 0 ? void 0 : _a.publicKey))
            throw new Error('Public Key not set.');
        if (!((_b = this.identity) === null || _b === void 0 ? void 0 : _b.fingerprint))
            throw new Error('Fingerprint not set.');
        if (!((_c = this.identity) === null || _c === void 0 ? void 0 : _c.keyId))
            throw new Error('Key ID not set.');
        const cleanPublicKey = this.identity.publicKey
            .replace(/\n?-{5}\n?[\w\s]+\n?-{5}\n?/g, '')
            .replace(/=+$/g, '');
        return {
            type: 'TXT',
            name: `${prefix}._auth.${this.domain}.`,
            value: `v=0;fingerprint=${this.identity.fingerprint};keyId=${this.identity.keyId};pubKey=${cleanPublicKey}`,
        };
    }
    /**
     * Generate Signature Data
     * @returns partial response data
     */
    async generateSignatureData() {
        if (!this.signature)
            throw new Error('Signature not set.');
        if (!this.clientDataJSON)
            throw new Error('ClientDataJSON not set.');
        if (!this.authenticatorData)
            throw new Error('AuthenticatorData not set.');
        return {
            signed: utils_1.encodeBase64(utils_1.arrayBufferToString(this.signature)),
            clientDataJSON: utils_1.encodeBase64(utils_1.arrayBufferToString(this.clientDataJSON)),
            authenticatorData: utils_1.encodeBase64(utils_1.arrayBufferToString(this.authenticatorData)),
        };
    }
    /**
     * Get Fingerprint from Response Data's Public Key
     * @returns fingerprint
     */
    async getFingerprint() {
        var _a;
        if (!((_a = this.resData) === null || _a === void 0 ? void 0 : _a.publicKey))
            throw new Error('Public Key not set.');
        let pubKey;
        try {
            pubKey = await cryptography_1.importCryptoKey(this.resData.publicKey);
        }
        catch (error) {
            console.error(error);
            throw new Error('Could not import invalid public key.');
        }
        return utils_1.calculateFingerprint(pubKey);
    }
}
exports.WebAuthnStrategy = WebAuthnStrategy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViQXV0aG4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL3N0cmF0ZWdpZXMvd2ViQXV0aG4vd2ViQXV0aG4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHNEQUFzRDs7O0FBRXRELHVDQVNxQjtBQUNyQiwwQ0FBK0M7QUFFL0MsaURBQWtFO0FBRWxFOztHQUVHO0FBQ0gsTUFBYSxnQkFBaUIsU0FBUSwyQkFBZ0I7SUFXcEQ7UUFDRSxLQUFLLEVBQUUsQ0FBQztRQVhELGlCQUFZLEdBQUcsa0JBQWtCLENBQUM7SUFZM0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSztRQUNILElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1FBQzNCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDOUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7SUFDM0IsQ0FBQztJQUVEOzs7T0FHRztJQUNILGNBQWMsQ0FBQyxPQUFvQjtRQUNqQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDN0MsQ0FBQztJQUVEOzs7T0FHRztJQUNILGVBQWUsQ0FBQyxZQUE4QjtRQUM1QyxJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztJQUNuQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsZUFBZSxDQUFD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